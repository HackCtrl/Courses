***Дистрибутив Linux состоит из нескольких компонентов:*** 
- Загрузчик 
- Ядро 
- Система инициализации
- Демоны 
- Командная оболочка 
- Библиотеки и утилиты 
- Графический сервер 
- Пакетный менеджер
## ***Bootstrap: процесс загрузки ОС***

*Прежде чем появится первые пользовательские процессы, компьютеру нужно выполнить процедуру  «бутстрапа» (bootstrap process) - загрузить ОС* 
![[Pasted image 20251115151326.png]]

1. Проверка и инициализация аппаратных компонентов (при включении питания, пк проверяет работоспособность своих компонентов)
2. Запуск загрузчика (GRUB - GRand Unified Bootloader — «великий объединённый загрузчик»)
3. Загрузка ядра ОС (отвечает за управление ресурсами пк и предоставлением интерфейса для взаимодействия с ОС)
4. Запуск системных служб и драйверов
## ***Первоначальная инициализация оборудования***

***IBM-PC-совместимой (или просто PC)*** - физическая современная архитектура компьютера 

***Физическая архитектура*** - общая структура и компоновка аппаратных компонентов (процессора, памяти, накопителей, шины данных, периферийных устройств и системы питания). Она определяет, как все это взаимодействует и интегрировано в систему

***шины адреса (англ. address bus)*** - количество проводов-контактов в ней, которое определяет способ адресации оперативной памяти. Например, шина с 32 проводами может адресовать 2^32 байта оперативной памяти, что равно 4 Гб.

***Познакомиться с альтернативными архитектурами:***
- Apple Macintosh, основанная на процессорах x86 (а ранее — на PowerPC). Известна своей эффективностью и производительностью, интеграцией с операционной системой macOS
- ARM (от англ. Advanced RISC Machine — «усовершенствованная RISC-машина») — одна из самых распространённых архитектур для мобильных и IoT-устройств, включая умные часы и другие встроенные системы
- SPARC (от англ. Scalable Processor ARChitecture — «масштабируемая процессорная архитектура»), разработанная компанией Sun Microsystems, известной сейчас как Oracle
- MIPS (от англ. Microprocessor without Interlocked Pipeline Stages — «микропроцессор без блокировок в конвейере»), разработка компании MIPS Technologies. Изначально предназначалась для встраиваемых систем, но используется и в некоторых серверных и мобильных устройствах
- RISC-V — открытая инструкционная архитектура, разработанная в Калифорнийском университете в Беркли. Предоставляет свободный доступ к спецификациям и может быть реализована на разных процессорах
- PowerPC — совместная разработка компаний IBM, Motorola и Apple

*Когда вы нажимаете на кнопку включения, питание подаётся на специальный контакт процессора — reset pin (от англ. reset — «сброс», pin — «контакт»). Он «пробуждает» логические схемы процессора, которые устанавливают первоначальное состояние — адрес первой инструкции в «реальном» адресном режиме.*
## ***Прошивка сервера***

***UEFI и BIOS*** - это разные, но в чем то схожие системны, управляющие процессом загрузки компьютера 

***BIOS (Basic Input/Output System — «базовая система ввода-вывода»):***
- более старая технология, существующая уже десятилетия и постепенно вытесняемая UEFI;
- в основном работает в 16-битном режиме, что ограничивает её возможности;
- есть ограничения на размер кода и поддерживаемые устройства;
- использует Master Boot Record (MBR) для загрузки ОС. У MBR есть ограничение на объём дисков — они должны быть до 2 Тб;
- обычно предоставляет простой интерфейс: чёрный экран с белым текстом;
- предлагает меньше возможностей, чем UEFI, например, меньше контроля над загрузкой устройств.
***UEFI (от англ. Unified Extensible Firmware Interface — «унифицированный расширяемый интерфейс прошивки»):***
- более современная технология, разработанная для замены BIOS;
- работает в 64-битном режиме, что позволяет использовать больше памяти;
- нет жёстких ограничений на размер кода и поддерживаемые устройства;
- использует GUID Partition Table (GPT) для загрузки ОС — GPT поддерживает диски большего размера, чем MBR;
- оснащён более удобным для пользователя графическим интерфейсом (GUI);
- предлагает больше возможностей: безопасную (Secure Boot) и быструю загрузку, поддержку больших дисков и сетевых протоколов, более гибкие настройки.
## ***Загрузчик ОС***

1. Прямой запуск
2. Через посредников (GRUB2 - умный посредник и может запускать различные программы)
## ***Разметка диска для загрузки Linux***

| **Помещение**               | **Что в нём хранится**                                                             |
| --------------------------- | ---------------------------------------------------------------------------------- |
| `root`, `/` — жилая комната | Файлы операционной системы (самые необходимые для жизни семьи вещи).               |
| `home`, `/home` — кладовая  | Файлы пользователей (все остальные личные вещи семьи).                             |
| `swap` — гараж              | Виртуальная память (дополнительное место для вещей, которые не помещаются в доме). |
| Другие разделы              | Это дополнительные помещения, предназначенные для специальных целей.               |
*Способ разбиения диска на разделы зависит от типа прошивки компьютера и таблицы разделов* 
#### ***UEFI + GPT***

*Если используются UEFI и GPT, на жёстком диске создаётся раздел EFI System Partition (ESP) с образом приложения GRUB2. Он должен быть отформатирован в файловую систему VFAT с типом раздела EFI System Partition, где будет находиться файл `/EFI/<vendor>/grubx64.efi`*
#### ***BIOS и MBR***

*В этом случае GRUB2 хитрит. В MBR, первом секторе жёсткого диска, записывает первую стадию загрузчика GRUB2. Один сектор, или 512 байт, — очень маленький объём для неё. С учётом того, что там же находится таблица разделов, коду загрузчика достаётся всего от 398 до 446 байт. Этого объёма не хватит на драйверы файловых систем, которые нужны для чтения и запуска файла ядра ОС с диска.*

*В промежутке между первым сектором и первым разделом диска есть пустое пространство — оно необходимо для совместимости со старыми ОС. GRUB2 использует его для хранения промежуточной полуторной стадии загрузчика. Код считывает её из известного места на диске и передаёт промежуточной стадии управление.*

*Размер кода полуторной стадии уже достаточно велик для драйверов файловых систем. Он считывает конфигурацию загрузчика из файла `/boot/grub/grub.cfg` и показывает пользователю меню выбора загрузки: загружает образ второй стадии загрузчика GRUB2 из раздела `/boot`, который уже форматируется в обычную ФС для Linux.*
#### ***BIOS + GPT***

*А вот здесь такая хитрость не пройдёт! В таблице разделов GPT нет пустого пространства между первым сектором и первым разделом — его занимает список разделов. Поэтому GRUB2 использует специальный раздел BIOS boot partition, где находится бинарный код полуторной стадии загрузчика.*
## ***Работа загрузчика***

***Задача загрузчика*** - найти файл ядра ОС на устройстве хранения и запустить его. 

***Работа GRUB2 в BIOS-режиме состоит из трех стадий:*** 
- Стадия 1. Загрузка кода из первого сектора диска (MBR) при настройке GRUB2: 
`$ file /boot/grub/i386-pc/boot.img /boot/grub/i386-pc/boot.img: DOS/MBR boot sector $ ls -lh /boot/grub/i386-pc/boot.img rw-r--r-- 1 root root 512 Jul 13 17:00 /boot/grub/i386-pc/boot.img`
- ***Стадия 1.5. Загрузка драйверов ФС и передача управления второй стадии загрузки***
- ***Стадия 2. Загрузка ядра ОС и передача ему управления (команда загрузки файл ядра, пример):***
`linux /boot/vmlinuz-5.15.0-78-generic root=/dev/vda2`

*В UEFI-режиме загрузчик GRUB2 может работать как обычное UEFI-приложение. Для этого используется специальный раздел ESP, где хранится файл `/EFI/<vendor>/grubx64.efi`. Прошивка UEFI может запустить этот файл напрямую.*

***Загрузчик — часть ОС, его можно исследовать на хосте. Необходимые для загрузки ОС файлы находятся в директории `/boot`:*** 
- `$ ls /boot System.map-5.15.0-82-generic  initrd.img-5.15.0-91-generic System.map-5.15.0-91-generic  initrd.img.old config-5.15.0-82-generic      vmlinuz config-5.15.0-91-generic      vmlinuz-5.15.0-82-generic`
- `vmlinuz` — образ ядра, который содержит все компоненты для запуска ОС.
- `initrd.img` — начальный RAM-диск. Он нужен для монтирования файловых систем перед загрузкой основной системы.
- `System.map` — файл с информацией о структуре ядра: идентификаторах процессов и модулей.
- `config` — файл конфигурации, использующийся при компиляции ядра.
- `grub` — директория с конфигом для GRUB. Возможны разные его версии: `vmlinuz`, `initrd.img`, `System.map`, `config`.
## ***Ранние стадии загрузки ядра Linux***

***Файл ядра Linux (образ)*** - это сжатый исполняемый файл, который буквально распаковывает сам себя после загрузки в оперативную память 

*gzip — один из популярных алгоритмов компрессии данных. Другие могут обеспечить ещё более высокую степень сжатия, например xz, но для задач загрузки ОС, когда важен баланс размера, скорости распаковки и сжатия и простоты интеграции gzip зачастую оптимален. Более сложные алгоритмы могут незначительно ускорить загрузку.*

***Если нужно разместить корневую ФС на сетевом хранилище, доступном по защищенным протоколам, зашифровать ФС или организовать RAID массив из нескольких дисков:*** 
- ***Поможет initrd** — специальный образ файловой системы. Загрузчик GRUB2 по умолчанию предназначен для чтения файлов с загрузочного устройства, и ему делегируется задача создания временной корневой ФС в оперативной памяти.* (это специальный образ файловой системы, который загружается в оперативную память загрузчиком GRUB2. Он нужен для того, чтобы ядро Linux могло монтировать корневую файловую систему и запускать необходимые драйверы и утилиты без обращения к внешним устройствам. В initrd можно добавлять утилиты и драйверы для работы с файловыми системами и системами хранения, не изменяя и не перекомпилирую код ядра.)
## ***Передача управления системе инициализации и первые пользовательские процессы***

*Загрузив initrd в оперативную память, ядро Linux монтирует образ в качестве корневой ФС и запускает shell-скрипт, или `/init`*

В скрипте /init выполняется разбор параметров загрузки ядра. И один из них указывает путь к исполняемому файлу первого init-процесса по умолчанию это init=/sbin/init

***Упрощенный вид процесса загрузки:*** 
- *Нажатие на кнопку → Инициализация оборудования → Firmware (BIOS или UEFI) → Выбор источника загрузки → Загрузчик GRUB2 → Ядро Linux и initrd → Переключение на реальную Root FS → Запуск systemd.*
## ***Система инициализации***

***Система инициализации Linux*** - это первый процесс при создании пользовательского окружения. Он включает монтирование ФС, запуск демонов и процессов 

***Супервизор*** - компонент, контролирующий состояние сервисов и обеспечивающий их устойчивую работу 



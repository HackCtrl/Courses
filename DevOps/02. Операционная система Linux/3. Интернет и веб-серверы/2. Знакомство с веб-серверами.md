
***Аппаратный веб-сервер*** - это устройство, подключенное к сети. Он хранит файлы сайта и обеспечивает к ним доступ

***Программный веб-сервер*** - это HTTP-сервер, который умеет работать с URL, адресами и многим другим.

***Взаимодействие по HTTP-протоколу***

***У сервера есть возможность настроить переадресацию*** - перенаправление с одного сайта на другой или с одной страницы на другую в рамках одного сайта

***Каким может быть веб-сервер:***

***Веб-сервер бывает статическим и динамическим:***
- Статический отдает клиенту ресурс как есть
- Динамический формирует ответ в зависимости от запроса клиента

***Как настроить сервер nginx:***

***Установка nginx***
- `sudo apt update`
- `sudo apt upgrade`
- `sudo apt install nginx`
- `sudo systemctl start nginx`

***Однострочная директива:***
- `worker_processes  24;`

***Блочная директива:***
- `events {`
	`worker_connections  1024;`
	`}`

*Структура конфигурационного файла состоит из блоков, их называют **контекстами**.*

***Простая конфигурация:***
`server {`
`listen      80;`
`server_name example.org www.example.org;`
`...`
`}`

***Что мы видим:***
- `listen` описывает порт подключения, на котором виртуальный сервер будет принимать соединение, а иногда и адрес сервера, где развернут ngnix
- `server_name` по нему сервер узнает, какой из обслуживаемых сайтов запрашивается

`location` ***(директива)*** - образец, по которому ngix будет проверять все запрос, который к нему поступают

`location /images/ {`
`root /data;`
`}`

В этом примере блок location задаёт фильтр (префикс) /images/, который сравнивается с URL из запроса. Все запросы, содержащие в качестве URL строки с /images/, будут преобразованы в запросы к локальной файловой системе в папке /data. Под это условие подпадают такие запросы:
- `/images/2.png` — сервер вернёт файл /data/2.png;
- `/images/photo.jpg` — сервер вернёт файл /data/photo.jpg;
- `/images/photos/1.jpg` — сервер вернёт файл /data/photos/1.jpg.

***location могут быть заданы регулярными выражениями:***
- `~ \\.(gif|jpg|png)$` (будет отображать запросы, которые оканчиваюися на .gif, .jpg, .png)

***На условие выбора location можно влиять модификаторами:***
![[Pasted image 20251111191450.png]]

***Пример конфигурации:***
`location = / {`
`[ набор правил 1 ]`
`}`
`location / {`
`[ набор правил 2 ]`
`}`
`location /files/ {`
`[ набор правил 3 ]`
`}`
`location ^~ /images/ {`
`[ набор правил 4 ]`
`}`
`location ~* \.(gif|jpg|png)$ {`
`[ набор правил 5 ]`
`}`

***Директива include*** - можно включить содержимое одного файла в другой

***Настройка nginx для обработки статического контента:***

***Создадим файл конфигурации:*** 
`sudo nano /etc/nginx/sites-enabled/static`

***Конфигурация:*** 
`server {` 
`listen 80 default_server;` 
`server_name example.net;` 
`location / {` 
`root /var/www/html;` 
`}` 
`}`

`default_server` указывает на то, что все запросы, которые не попадают на порт `80`, будут обрабатываться в этом блоке `server`

***Чтобы избежать конфликтов с конфигурацией по умолчанию:*** 
`rm  /etc/nginx/sites-enabled/default .`

***Команда для применения настроек:*** 
`nginx -s reload`

***Ссылка для проверки результата:*** 
`http://{ip}/index.nginx-debian.html` (ip, этот тот адрес куда мы устанавливали)
`index.nginx-debian.html` — это имя файла, который лежит в папке `/var/www/html` на сервере. Если не указывать в URI имя файла и перейти по адресу `http://{ip}`, где `ip` — адрес сервера, куда установлен nginx, то выйдет ошибка `404`

По умолчанию nginx ищет файл `index.html` в папке, которая указана в директиве `root` для каждого `location`. Это поведение можно переопределить директивой `index`. Она определяет имена файлов, которые будут использоваться в качестве индексных. Наличие файлов проверяется в порядке их перечисления. В конце списка может стоять файл с абсолютным путём. Добавим эту директиву в `location`:

```
server {

listen 80 default_server;

server_name example.net;

location / {

root /var/www/html;

index index.nginx-debian.html;

}

} 
```

Теперь при открытии `http://{ip}/`, где `ip` — адрес сервера, куда установлен nginx, он будет искать файл `/var/www/html/index.nginx-debian.html` и вернёт его содержимое.

Для просмотра содержимого директории можно использовать директиву `autoindex on;`:

```
server {

listen 80 default_server;

server_name example.net;

location / {

root /var/www/html;

autoindex on;

}

} 
```

В этом случае nginx будет создавать индекс из содержимого папки, заданной в директиве `root`.
#### ***Настройка nginx для динамического контента: FastCGI***

***CGI (common gateway interface — «общий интерфейс шлюза»)*** - для связи между программой и веб-сервером 

***Настройкаnginx + PHP-FPM***

***Команда для установки:*** 
- `sudo apt install php8.3-fpm`

Проверьте, запущен ли PHP-FPM, командой `systemctl status php8.3-fpm`. Для дальнейшей настройки нам понадобится значение директивы `listen` из файла `./pool.d/www.conf`. Посмотреть её можно двумя способами:

- с помощью команды `grep "^listen =" /etc/php/8.3/fpm/pool.d/www.conf`;
- открыв в редакторе, например `nano /etc/php/8.3/fpm/pool.d/www.conf`.

Теперь нам необходимо настроить nginx для перенаправления некоторых запросов в PHP-FPM. Добавьте в нашем файле `/etc/nginx/sites-enabled/static` новый `location` в контекст `server`:

```
# Запросы, в которых URI оканчивается на .php, будут обработаны в этом location
location ~ \.php$ {
    include snippets/fastcgi-php.conf;

    # Указываем сокет, через который Nginx будет передавать запросы PHP-FPM
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;

    # Указываем путь к исполняемому PHP-скрипту
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
} 
```

Для применения настроек выполните команду `nginx -s reload`.

